rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users Collection Rules
    match /users/{userId} {
      // ðŸš¨ TEMPORARY FIX:
      // Allow unauthenticated list + get so deviceId queries during registration work.
      // This makes the entire users collection publicly readable, so use only while debugging.
      allow list, get: if true;

      // Allow authenticated users to read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;

      // Allow creation of new user documents by the authenticated user
      // Enforce initial state for sensitive fields
      allow create: if request.auth != null && request.auth.uid == userId
                    && request.resource.data.email == request.auth.token.email
                    && request.resource.data.keys().hasAll([
                      'email',
                      'coins',
                      'adsWatchedToday',
                      'lastAdWatchDate',
                      'referralCode',
                      'referredBy',
                      'isAdmin',
                      'spinWheelFreeSpinsToday',
                      'spinWheelAdSpinsToday',
                      'lastSpinWheelDate',
                      'deviceId',
                      'projectId'
                    ])
                    && request.resource.data.email is string
                    && request.resource.data.coins == 0; // New users start with 0 coins
    }

    // TODO: add rules for other collections if needed
  }
}
